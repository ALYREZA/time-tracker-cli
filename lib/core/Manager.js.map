{"version":3,"sources":["../../src/core/Manager.js"],"names":["Manager","cfg","repositories","tasks","all","config","key","task","update","get","Object","assign","set","description","t","getTask","start","then","storeTask","console","log","toISOString","catch","pause","unpause","stop","text","setDescription","name","getSeconds","operation","stringTime","makeOperationOverTime","string","keys","forEach","indexOf","push","search","map","k","join","length","prompt","type","message","default","answers","cls","unflatten","element","value","configElements","toString","newCfg","newTasks","migratedTasks","rate","full"],"mappings":"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","file":"Manager.js","sourcesContent":["import flat from 'flat'\nimport moment from 'moment'\nimport inquirer from 'inquirer'\n\nimport Task from './Task'\nimport { recognizeModifierTiming } from './utils'\nimport { STARTED, PAUSED, UNPAUSED, IN_PROGRESS, FINISHED, configElements } from './constants'\nimport { sumarize, outputVertical, cliError, cliSuccess } from './output'\nimport { migrateToV2 } from './dbMigrations'\n\nexport default class Manager {\n\n    repositories = ['tasks', 'config']\n\n    constructor(cfg) {\n        this.cfg = cfg\n        this.tasks = cfg.all.tasks\n        this.config = (cfg.all.config) ? cfg.all.config : {}\n    }\n\n    getTask(key) {\n        let task = (this.tasks[key]) ? this.tasks[key] : null\n        return new Task(task)\n    }\n\n    storeTask(key, task){\n        let update = {}\n        update[key] = task.get()\n        this.tasks = Object.assign({}, this.tasks, update)\n        this.cfg.set('tasks', this.tasks)\n    }\n\n    startTask(key, description) {\n        let t = this.getTask(key)\n        t.start(description)\n            .then(() => {\n                this.storeTask(key, t)\n                console.log(\n                    outputVertical('Task:', key, STARTED, moment().toISOString())\n                )\n            }, cliError)\n            .catch(cliError)\n    }\n\n    pauseTask(key){\n        let t = this.getTask(key)\n        t.pause()\n            .then(()=>{\n                this.storeTask(key, t)\n                console.log(\n                    outputVertical('Task:', key, PAUSED, moment().toISOString())\n                )\n            }, cliError)\n            .catch(cliError)\n    }\n\n    unpauseTask(key){\n        let t = this.getTask(key)\n        t.unpause()\n            .then(()=>{\n                this.storeTask(key, t)\n                console.log(\n                    outputVertical('Task:', key, UNPAUSED, moment().toISOString())\n                )\n            }, cliError)\n            .catch(cliError)\n    }\n\n    stopTask(key, description) {\n        let t = this.getTask(key)\n        t.stop(description)\n            .then(()=>{\n                this.storeTask(key, t)\n                console.log(\n                    outputVertical('Task:', key, FINISHED, moment().toISOString())\n                )\n            }, cliError)\n            .catch(cliError)\n    }\n\n    addDescription(key, text){\n        let t = this.getTask(key)\n        t.setDescription(text)\n        this.storeTask(key, t)\n    }\n\n    getTime(name) {\n        let t = this.getTask(name)\n        return t.getSeconds()\n    }\n\n    modifyTask(operation, name, stringTime){\n        let t = this.getTask(name)\n        t.makeOperationOverTime(operation, stringTime)\n            .then(()=>{\n                this.storeTask(name, t)\n            }, cliError)\n            .catch(cliError)\n    }\n\n    search(string) {\n        let keys = Object.keys(this.tasks)\n        let tasks = []\n        keys.forEach((key)=>{\n            if (string === 'all' || key.indexOf(string) > -1){\n                tasks.push({\n                    name: key,\n                    task: new Task(this.tasks[key])\n                })\n            }\n        })\n        return tasks\n    }\n\n    delete(string) {\n        let tasks = this.search(string)\n\n        console.log(\n            tasks.map(k => `${k.name} \\n`).join('')\n        )\n\n        if (tasks.length === 0) {\n            cliSuccess('No tasks found to delete.')\n            return\n        }\n\n        inquirer.prompt([{\n            type: 'confirm',\n            name: 'cls',\n            message: `Are you sure you want to delete this tasks?`,\n            default: false\n        }]).then((answers) => {\n            if (answers.cls){\n                tasks.forEach(k => {\n                    delete this.tasks[k.name]\n                    this.cfg.set('tasks', this.tasks)\n                })\n                cliSuccess('Tasks deleted.')\n            }\n        })\n        .catch(cliError)\n    }\n\n    getTasksJson() {\n        return flat.unflatten(this.tasks)\n    }\n\n    getConfig(){\n        return this.config\n    }\n\n    configure(element, value){\n\n        if (configElements.indexOf(element) < 0){\n            return cliError(`Config key (${element}) not allowed, allowed keys: ${this.configElements.toString()} `)\n        }\n\n        let newCfg = {\n            [element]: value\n        }\n\n        this.config = Object.assign({}, this.config, newCfg)\n        this.cfg.set('config', this.config)\n\n        return this.config\n    }\n\n    update() {\n        if (!this.config || (this.config && this.config['config.version'] !== '2') ){\n            console.log('DB: Need to be updated')\n\n            migrateToV2(this.tasks)\n                .then(tasks => {\n                    let newTasks = {}\n                    tasks.forEach(t => newTasks[t.key] = t.task)\n                    return newTasks\n                })\n                .then(migratedTasks => {\n                    this.cfg.set('tasks', migratedTasks)\n                    this.cfg.set('config', Object.assign(this.config, {\n                        'config.version': '2'\n                    }))\n\n                    cliSuccess('Configuration migrated to version 2.')\n                }, cliError)\n                .catch(cliError)\n        } else {\n            cliSuccess('No need to update the DB.')\n        }\n    }\n\n    sumarize(key, rate, full=true){\n        let tasks = this.search(key)\n        sumarize(key, tasks, rate, full, this.config['format.output'])\n    }\n}\n"]}