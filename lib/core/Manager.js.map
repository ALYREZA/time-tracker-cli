{"version":3,"sources":["../../src/core/Manager.js"],"names":["Manager","cfg","configElements","repositories","tasks","all","config","migrateToV2","then","migratedTasks","set","Object","assign","catch","key","task","update","get","description","t","getTask","start","storeTask","console","log","toISOString","pause","unpause","stop","text","setDescription","name","getSeconds","operation","stringTime","makeOperationOverTime","string","keys","forEach","indexOf","push","unflatten","element","value","toString","newCfg","Promise","resolve","reject","k","timings","rate","full","search"],"mappings":"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","file":"Manager.js","sourcesContent":["import flat from 'flat'\n\nimport Task from './Task'\nimport moment from 'moment'\n\nimport { recognizeModifierTiming } from './utils'\nimport { STARTED, PAUSED, UNPAUSED, IN_PROGRESS, FINISHED } from './constants'\nimport { sumarize, outputVertical, cliError } from './output'\n\nexport default class Manager {\n\n    configElements = ['format.output']\n    repositories = ['tasks', 'config']\n\n    constructor(cfg) {\n        this.cfg = cfg\n        this.tasks = cfg.all.tasks\n        this.config = (cfg.all.config) ? cfg.all.config : {}\n\n        if (!this.config['config.version']){\n            this.migrateToV2(this.tasks)\n                .then((migratedTasks)=>{\n                    this.cfg.set('tasks', migratedTasks)\n                    this.cfg.set('config', Object.assign(this.config, {\n                        'config.version': 2\n                    }))\n                }, cliError)\n                .catch(cliError)\n        }\n    }\n\n    getTask(key) {\n        let task = (this.tasks[key]) ? this.tasks[key] : null\n        return new Task(task)\n    }\n\n    storeTask(key, task){\n        let update = {}\n        update[key] = task.get()\n        this.tasks = Object.assign({}, this.tasks, update)\n        this.cfg.set('tasks', this.tasks)\n    }\n\n    startTask(key, description) {\n        let t = this.getTask(key)\n        t.start(description)\n            .then(() => {\n                this.storeTask(key, t)\n                console.log(\n                    outputVertical('Task:', key, STARTED, moment().toISOString())\n                )\n            }, cliError)\n            .catch(cliError)\n    }\n\n    pauseTask(key){\n        let t = this.getTask(key)\n        t.pause()\n            .then(()=>{\n                this.storeTask(key, t)\n                console.log(\n                    outputVertical('Task:', key, PAUSED, moment().toISOString())\n                )\n            }, cliError)\n            .catch(cliError)\n    }\n\n    unpauseTask(key){\n        let t = this.getTask(key)\n        t.unpause()\n            .then(()=>{\n                this.storeTask(key, t)\n                console.log(\n                    outputVertical('Task:', key, UNPAUSED, moment().toISOString())\n                )\n            }, cliError)\n            .catch(cliError)\n    }\n\n    stopTask(key, description) {\n        let t = this.getTask(key)\n        t.stop(description)\n            .then(()=>{\n                this.storeTask(key, t)\n                console.log(\n                    outputVertical('Task:', key, FINISHED, moment().toISOString())\n                )\n            }, cliError)\n            .catch(cliError)\n    }\n\n    addDescription(key, text){\n        let t = this.getTask(key)\n        t.setDescription(text)\n        this.storeTask(key, t)\n    }\n\n    getTime(name) {\n        let t = this.getTask(name)\n        return t.getSeconds()\n    }\n\n    modifyTask(operation, name, stringTime){\n        let t = this.getTask(name)\n        t.makeOperationOverTime(operation, stringTime)\n            .then(()=>{\n                this.storeTask(name, t)\n            }, cliError)\n            .catch(cliError)\n    }\n\n    search(string) {\n        let keys = Object.keys(this.tasks)\n        let tasks = []\n        keys.forEach((key)=>{\n            if (string === 'all' || key.indexOf(string) > -1){\n                tasks.push({\n                    name: key,\n                    task: new Task(this.tasks[key])\n                })\n            }\n        })\n        return tasks\n    }\n\n    getTasksJson() {\n        return flat.unflatten(this.tasks)\n    }\n\n    getConfig(){\n        return this.config\n    }\n\n    configure(element, value){\n\n        if (this.configElements.indexOf(element) < 0){\n            return cliError(`Config key (${element}) not allowed, allowed keys: ${this.configElements.toString()} `)\n        }\n\n        let newCfg = {\n            [element]: value\n        }\n\n        this.config = Object.assign({}, this.config, newCfg)\n        this.cfg.set('config', this.config)\n\n        return this.config\n    }\n\n    migrateToV2(tasks){\n        return new Promise((resolve, reject)=>{\n            Object.keys(tasks).forEach(k => {\n                if (!tasks[k].timings){\n                    reject('Config migrated')\n                }\n\n                if (!tasks[k].start && !tasks[k].stop){\n                    reject('Config corrupted or migrated')\n                }\n\n                tasks[k].timings = [{\n                    start: (tasks[k].start) ? tasks[k].start : null,\n                    stop: (tasks[k].stop) ? tasks[k].stop : null\n                }]\n\n                delete tasks[k].start\n                delete tasks[k].stop\n            })\n\n            resolve(tasks)\n        })\n\n    }\n\n    sumarize(key, rate, full=true){\n        let tasks = this.search(key)\n        sumarize(key, tasks, rate, full, this.config['format.output'])\n    }\n}\n"]}